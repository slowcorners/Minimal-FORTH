                                                              ORG     0x8000
                                                      
                                                      
                                                      ; INCLUDE         defs.asm
                                                      
                                                      CH_DEL  EQU     127
                                                      
                                                      
                                                      ; INCLUDE         boot-table.asm
                                                      
                                                      ; ----------------------------------------------------------------------
                                                      ; BOOT TABLE
                                                      
8000 14 00 00                                         ORIGIN: JPA     CENT            ;  0: COLD start
8003 00                                                       NOP
8004 14 00 00                                                 JPA     WENT            ;  4: WARM start
8007 00                                                       NOP
8008 00 00                                                    DW      0               ;  8: Processor type in radix 36
800A 00 00                                                    DW      0               ; 10: Revision
800C 00 00                                                    DW      HFORTH          ; 12: Pointer to latest word defined
800E 7F 00                                                    DW      CH_DEL          ; 14: Backspace character
8010 00 00                                                    DW      XUP             ; 16: Pointer to initial user area
8012 00 00                                                    DW      XSP             ; 18: Initial data stack pointer
8014 00 00                                                    DW      XRP             ; 20: Initial data stack pointer
8016 00 00                                                    DW      XTIB            ; 22: Pointer to terminal input buffer
8018 1F 00                                                    DW      31              ; 24: Maximum FORTH word name length
801A 00 00                                                    DW      0               ; 26: Initial WARNING mode
801C 00 00                                                    DW      XDP             ; 28: Initial FENCE
801E 00 00                                                    DW      XDP             ; 30: Initial HERE
8020 00 00                                                    DW      XXVOC           ; 32: Pointer to initial VOC-LINK
8022 00 00                                                    DW      DSKBF           ; 34: Initial FIRST
8024 00 00                                                    DW      ENDBF           ; 36: Initial LIMIT
8026 00 00                                                    DW      0               ; 38: unused
8028 00 00                                                    DW      0               ; 40: unused
                                                      
                                                      ; INCLUDE         regs.asm
                                                      
                                                      ; ----------------------------------------------------------------------
                                                      ; THE VIRTUAL FORTH MACHINE REGISTERS
                                                      
                                                      IP:                             ; Instruction Pointer
802A 00                                               IPlo:   DB      0
802B 00                                               IPhi:   DB      0
                                                      
                                                      WA:                             ; Word Address Register
802C 00                                               WAlo:   DB      0
802D 00                                               WAhi:   DB      0
                                                      
                                                      RegBC:                          ; Working register R1
802E 00                                               RegB:   DB      0
802F 00                                               RegC:   DB      0
                                                      
                                                      RegDE:                          ; Working register R2
8030 00                                               RegD:   DB      0
8031 00                                               RegE:   DB      0
                                                      
                                                      SP:                             ; Data stack pointer
8032 00                                               SPlo:   DB      0
8033 00                                               SPhi:   DB      0
                                                      
                                                      RP:                             ; Return stack pointer
8034 00                                               RPlo:   DB      0
8035 00                                               RPhi:   DB      0
                                                      
                                                      UP:                             ; User area pointer
8036 00                                               UPlo:   DB      0
8037 00                                               UPhi:   DB      0
                                                      
                                                      
                                                      ; INCLUDE         helpers.asm
                                                      
                                                      ; ----------------------------------------------------------------------
                                                      ; HELPER FUNCTIONS
                                                      ;
                                                      
                                                      ; ------------------------------
                                                      ;       RegDE = (IP)+
                                                      
8038 1D 2A 80                                         _LIT:   LDR     IP
803B 16 31 80                                                 STA     RegE
803E 2E 2A 80                                                 INW     IP
8041 1D 2A 80                                                 LDR     IP
8044 16 30 80                                                 STA     RegD
8047 2E 2A 80                                                 INW     IP
804A 39                                                       RTS
                                                      
                                                      ; ------------------------------
                                                      ;       IP = IP + (IP)+
                                                      
804B 1D 2A 80                                         _BRAN:  LDR     IP
804E 16 31 80                                                 STA     RegE
8051 2E 2A 80                                                 INW     IP
8054 1D 2A 80                                                 LDR     IP
8057 16 30 80                                                 STA     RegD
805A 2F 2A 80                                                 DEW     IP
805D 15 31 80                                                 LDA     RegE
8060 28 2A 80                                                 ADB     IPlo
8063 15 30 80                                                 LDA     RegD
8066 2A 2B 80                                                 ACB     IPhi
8069 39                                                       RTS
                                                      
                                                      ; ------------------------------
                                                      ;       RegD = RegE & RegD
                                                      
806A 0E 08                                            AND:    LDI     8               ; Load bit counter
806C 16 2F 80                                                 STA     RegC            ; :
806F 15 31 80                                         AND10:  LDA     RegE            ; Load second operand
8072 05                                                       LSL                     ; Shift 2b7 into C
8073 16 31 80                                                 STA     RegE            ; Store shifted second operand
8076 15 30 80                                                 LDA     RegD            ; Load first operand
8079 3C 82 80                                                 BCC     AND20           ; If C is clear: Shift in a zero
                                                              ; 2b7 is set
807C 11 00                                                    CPI     0               ; Is first operand < 0, i.e. is 1b7 set?
807E 3F 82 80                                                 BMI     AND20           ; N is set: 1b7 is set
                                                              ; 1b7 is clear
8081 03                                                       CLC                     ; 1b7 is clear: Clear C
8082 06                                               AND20:  ROL                     ; Shift C into result
8083 16 30 80                                                 STA     RegD            ; Store first operand/result
8086 27 2F 80                                                 DEB     RegC            ; All bits done?
8089 3A 6F 80                                                 BNE     AND10           ;   NO: Do one more
808C 39                                                       RTS                     ;   YES: All done
                                                      
                                                      ; ------------------------------
                                                      ;       RegD = RegE | RegD
                                                      
808D 0E 08                                            OR:     LDI     8               ; Load bit counter
808F 16 2F 80                                                 STA     RegC            ; :
8092 15 31 80                                         OR10:   LDA     RegE            ; Load second operand
8095 05                                                       LSL                     ; Shift 2b7 into C
8096 16 31 80                                                 STA     RegE            ; Store shifted second operand
8099 15 30 80                                                 LDA     RegD            ; Load first operand
809C 3D A5 80                                                 BCS     OR20            ; If C is set, shift it into result
                                                              ; 2b7 is clear
809F 11 00                                                    CPI     0               ; Is first operand < 0, i.e. is 1b7 set?
80A1 3F A5 80                                                 BMI     OR20            ; N is clear: 1b7 is clear
                                                              ; 1b7 is clear
80A4 03                                                       CLC                     ; Neither bit is set: Clear C 
80A5 06                                               OR20:   ROL                     ; Shift C into result
80A6 16 30 80                                                 STA     RegD            ; Store first operand/result
80A9 27 2F 80                                                 DEB     RegC            ; All bits done?
80AC 3A 92 80                                                 BNE     OR10            ;   NO: Do one more
80AF 39                                                       RTS                     ;   YES: All done
                                                      
                                                      ; ------------------------------
                                                      ;       RegD = RegE ^ RegD
                                                      
80B0 0E 08                                            XOR:    LDI     8               ; Load bit counter
80B2 16 2F 80                                                 STA     RegC            ; :
80B5 15 31 80                                         XOR10:  LDA     RegE            ; Get second operand
80B8 05                                                       LSL                     ; Shift b7 into C
80B9 16 31 80                                                 STA     RegE            ; Store shifted second operand
80BC 15 30 80                                                 LDA     RegD            ; Load first operand
80BF 3D CA 80                                                 BCS     XOR20           ; C is set, check 1b7 for zero
                                                              ; 2b7 is clear
80C2 11 00                                                    CPI     0               ; Is first operand < 0, i.e. is b7 set?
80C4 3F 00 00                                                 BMI     XOR90           ; 1b7 is set and 2b7 is clear, shift in C which is set
80C7 14 CF 80                                                 JPA     XOR30           ; 1b7 and 2b7 are both zero, clear C and shift in 
                                                              ; 2b7 is set, check 1b7 for zero
80CA 11 00                                            XOR20:  CPI     0
80CC 3E D0 80                                                 BPL     XOR40           ; If 1b7 is zero, shift in C which is set
80CF 03                                               XOR30:  CLC                     ; 1b7 and 2b7 are equal, shift in a zero
80D0 06                                               XOR40:  ROL                     ; Shift whatever is in C into result
80D1 16 30 80                                                 STA     RegD            ; Store first operand/result
80D4 27 2F 80                                                 DEB     RegC            ; All bits done?
80D7 3A B5 80                                                 BNE     XOR10           ;   NO: Do one more
80DA 39                                                       RTS                     ;   YES: All done
                                                      
                                                      ; INCLUDE         inner.asm
                                                      
                                                      ; ----------------------------------------------------------------------
                                                      ; INNER INTERPRETER
                                                      
80DB 2F 32 80                                         DPUSH:  DEW     SP              ; -(SP) = R2
80DE 15 00 00                                                 LDA     R2hi
80E1 1E 32 80                                                 STR     SP
80E4 2F 32 80                                                 DEW     SP
80E7 15 00 00                                                 LDA     R2lo
80EA 1E 32 80                                                 STR     SP
80ED 2F 32 80                                         PUSH:   DEW     SP              ; -(SP) = R1
80F0 15 00 00                                                 LDA     R1hi
80F3 1E 32 80                                                 STR     SP
80F6 2F 32 80                                                 DEW     SP
80F9 15 00 00                                                 LDA     R1lo
80FC 1E 32 80                                                 STR     SP
80FF 1D 2A 80                                         NEXT:   LDR     IP              ; WA = (IP)+
8102 16 2C 80                                                 STA     WAlo
8105 2E 2A 80                                                 INW     IP
8108 1D 2A 80                                                 LDR     IP
810B 16 2D 80                                                 STA     WAhi
810E 2E 2A 80                                                 INW     IP
8111 1D 2C 80                                         NEXT10: LDR     WA              ; R1 = (WA)+
8114 16 00 00                                                 STA     R1lo
8117 2E 2C 80                                                 INW     WA
811A 1D 2C 80                                                 LDR     WA
811D 16 00 00                                                 STA     R1hi
8120 2E 2C 80                                                 INW     WA
8123 1C 00 00                                                 JPR     R1              ; jump @(TMP)
                                                      
                                                      ; INCLUDE         primaries.asm
                                                      
                                                      ; ----------------------------------------------------------------------
                                                      ; FORTH PRIMARIES
                                                      ;
                                                      
8126 83 4C 49 D4                                      HLIT:   DB      ^3 "LI" ^'T'                            ; ***** LIT
812A 00 00                                                    DW      0
812C 2E 81                                            LIT:    DW      LIT0
812E 38 38 80                                         LIT0:   JPS     _LIT            ; move (IP)+, R1
8131 14 ED 80                                                 JPA     PUSH            ; push R1 and NEXT
                                                      
8134 87 45 58 45 43 55 54 C5                          HEXEC:  DB      ^7 "EXECUT" ^'E'                        ; ***** EXECUTE
813C 26 81                                                    DW      HLIT
813E 40 81                                            EXEC:   DW      EXEC0
8140 1D 32 80                                         EXEC0:  LDR     SP              ; move (SP)+, WA
8143 16 2C 80                                                 STA     WAlo
8146 2E 32 80                                                 INW     SP
8149 1D 32 80                                                 LDR     SP
814C 16 2D 80                                                 STA     WAhi
814F 2E 32 80                                                 INW     SP
8152 14 11 81                                                 JPA     NEXT10          ; jump @(WA)+
                                                      
8155 86 42 52 41 4E 43 C8                             HBRAN:  DB      ^6 "BRANC" ^'H'                         ; ***** BRANCH
815C 34 81                                                    DW      HEXEC
815E 60 81                                            BRAN:   DW      BRAN0
8160 38 4B 80                                         BRAN0:  JPS     _BRAN           ; add (IP), IP
8163 14 FF 80                                                 JPA     NEXT
                                                      
8166 87 30 42 52 41 4E 43 C8                          HZBRAN: DB      ^7 "0BRANC" ^'H'                        ; ***** BRANCH
816E 55 81                                                    DW      HBRAN
8170 72 81                                            ZBRAN:  DW      ZBRAN0
8172 1D 32 80                                         ZBRAN0: LDR     SP
8175 11 00                                                    CPI     0
8177 3A 8E 81                                                 BNE     ZBRA30          ; Low byte non-zero?
817A 2E 32 80                                                 INW     SP
817D 1D 32 80                                                 LDR     SP
8180 11 00                                                    CPI     0
8182 3A 91 81                                                 BNE     ZBRA50          ; High byte non-zero?
8185 2E 32 80                                                 INW     SP
8188 38 4B 80                                                 JPS     _BRAN           ; add (IP), IP
818B 14 FF 80                                                 JPA     NEXT
818E 2E 32 80                                         ZBRA30: INW     SP
8191 2E 2A 80                                         ZBRA50: INW     IP              ; Just skip jump offset
8194 2E 2A 80                                                 INW     IP
8197 14 FF 80                                                 JPA     NEXT
